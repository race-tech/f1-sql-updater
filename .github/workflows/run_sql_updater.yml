---
name: Run SQL updater

on:
  workflow_call:
    inputs:
      round:
        type: number
        required: true
        description: Round number.
      is-sprint:
        type: boolean
        required: true
        description: Is the round a sprint weekend.
      artifact-id:
        type: string
        required: true
        description: The artifact id of the artifact created by the race-tech/f1-data-downloader workflow.
      run-id:
        type: number
        required: true
        description: The run id of the workflow used to upload csv artifacts.
      f1-db-version:
        type: string
        required: false
        default: latest
        description: The F1 DB version to base the update on.
    outputs:
      artifact-id:
        value: ${{ jobs.run-updater.steps.upload-artifacts.outputs.artifact-id }}
        description: The artifact id of the sql dump generated.
      run-id:
        value: ${{ github.run_id }}
        description: The run id of this workflow.

jobs:
  run-updater:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
      MYSQL_PASSWORD: password
      MYSQL_DATABASE: f1db

    services:
      database:
        image: ghcr.io/race-tech/f1-db:${{ inputs.f1-db-version }}
        env:
          MYSQL_DATABASE: $MYSQL_DATABASE
          MYSQL_ROOT_PASSWORD: $MYSQL_PASSWORD
        ports:
          - 13306:3306
        options: --health-cmd="mysqladmin ping -u root" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Wait for database to be healthy
        run: |
          echo "Waiting for database service to be healthy..."
          for i in {1..30}; do
            STATUS=$(docker inspect --format='{{json .State.Health.Status}}' database)
            echo "Status: $STATUS"
            if [ "$STATUS" = "\"healthy\"" ]; then
              echo "Database is healthy!"
              exit 0
            fi
            echo "Not ready yet..."
            sleep 2
          done
          echo "Database failed to become healthy in time"
          exit 1

      - name: Verify f1db exists
        run: mysql --host 127.0.0.1 --port 13306 -uroot -e "SHOW DATABASES LIKE 'f1db'"
     
      - name: Retrieve latest binary
        run: gh release download --pattern 'f1-sql-updater'

      - name: Retrieve csv files
        uses: actions/download-artifact@v5
        with:
          artifact-ids: ${{ inputs.artifact-id }}
          repository: race-tech/f1-data-downloader
          github-token: ${{ secrets.GH_TOKEN }}
          run-id: ${{ inputs.run-id }}
          path: /etc/csv

      - name: Run updater
        run: |
          chmod +x ./f1-sql-updater
          ./f1-sql-updater ${{ inputs.round }} ${{ inputs.is-sprint }}

      - name: Create sql dump
        run: |
          mysqldump --host 127.0.0.1 --port 13306 -uroot f1db > f1db.sql
          gzip f1db.sql

      - name: Upload sql dump
        id: upload-artifacts
        uses: actions/upload-artifact@v4
        with:
          name: f1db.sql.gz
          path: f1db.sql.gz
